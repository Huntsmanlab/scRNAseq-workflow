---
title: '`r params$ids` Comparing endometrial clear cell and ovarian clear cell tumors'
subtitle: 
author: "aslÄ±"
date: '`r format(Sys.Date(), "%B %d, %Y")`'
output: 
  html_document:
    code_folding: hide

params:
  ids: 'DH8' # yay only one sample 
---

#### In this document, we explore DH8, (endometrioid_ovarian). We try various numbers of clusters and do DGE anlaysis between them.

```{r include = FALSE}

library(here)
source(here('pipeline', 'sourceFiles', 'utilities.R'))

```

```{r include = FALSE}

ids <- strsplit(params$ids, "-")[[1]] # split by "-" SO ID must NOT CONTAIN "-"
dh_organoid_ids <- list(ids[[1]])

# load the sce with the clustering information 
sce <- readRDS(here('..', 'data', 'clustered', 'sce', paste(dh_organoid_ids[[1]]), 'sce_clus.rds'))

```

#### Dimensionality reduction plots 
Here we show the TSNE and UMAP plots for DH8. Note that the best number of clusters were calculated by the algorithm. 
```{r echo = FALSE, message = FALSE, fig.height = 4, fig.width = 10} 

p1 <- plotTSNE(sce, colour_by = 'cluster')
p2 <- plotUMAP(sce, colour_by = 'cluster')

grid.arrange(p1, p2, nrow = 1)

```

Computer algorithm detects 15 separate clusters, but we can also try different numbers of clusters. Here we try 2 and 3 clusters and show the results in both TSNE and UMAP plots. 

```{r echo = FALSE, message = FALSE, fig.height = 8, fig.width = 10}

# computer detects 15 clusters, lets see what it looks like when we try only 3 clusters: 
set.seed(100)
sce3 <- sce
clust.kmeans <- kmeans(reducedDim(sce, "PCA"), centers = 3)
clust3 <- table(clust.kmeans$cluster)
clust3 <- as.data.frame(clust3) # turn it into a data frame 

sce3$cluster <- factor(clust.kmeans$cluster)
p3 <- plotReducedDim(sce3, "TSNE", colour_by="cluster")
p5 <- plotReducedDim(sce3, "UMAP", colour_by="cluster")

# now try 2 clusters 
set.seed(101)
sce2 <- sce
clust.kmeans <- kmeans(reducedDim(sce, "PCA"), centers = 2)
# table(clust.kmeans$cluster)

sce2$cluster <- factor(clust.kmeans$cluster)
p4 <- plotReducedDim(sce2, "TSNE", colour_by="cluster")
p6 <- plotReducedDim(sce2, "UMAP", colour_by="cluster")

# lets show them side by side: 
grid.arrange(p3, p4, p5, p6, nrow = 2)
```

#### DGE analysis between two clusters 

```{r include = FALSE}

# now we start some edgeR stuff 

group <- as.numeric(sce2$cluster)

dgeObject <- DGEList(counts = counts(sce2), genes = rownames(sce2), group = group) # make the DGE object 

# filter the lowly expressed genes - have at least in 0.5 cpm in at least 2 samples 
keep <- rowSums(cpm(dgeObject) > 0.5) >= 2 
dgeObject <- dgeObject[keep, ]

dgeObject <- calcNormFactors(dgeObject) # normalize using edgeR's method 

designMatrix <- model.matrix(~group)

# estimate the dispersion (variance) of genes 
dgeObject <- estimateDisp(dgeObject, design = designMatrix)

# fit negative binomial model to the data 
fit <- glmQLFit(dgeObject, designMatrix, robust = TRUE)

# compare group2 to 1, which is cluster2 vs cluster1
qlf <- glmQLFTest(fit, coef = 2)

# now do the comparison with a threshold of 2.0 for the fold change 
qlf_threshold <- glmTreat(fit, coef = 2, lfc = 1.0)

```

```{r include = FALSE}
# gene enrichment 
# Map gene names to entrez ids for goana and kegga. we have to convert from ensembl ids to entrez ids. 
geneIDs <- ensembldb::select(EnsDb.Hsapiens.v75, keys = rownames(qlf), keytype = "SYMBOL", columns = c("SYMBOL","ENTREZID"))

# sometimes we get duplicates, remove those 
geneIDs <- geneIDs[!duplicated(geneIDs$SYMBOL), ]
geneIDs <- geneIDs[!duplicated(geneIDs$ENTREZID), ]

# lets make sure we have the same genes in both 
idx <- is.na(geneIDs$ENTREZID)
idx_keep <- which(idx == FALSE)
qlf_modified <- qlf[idx_keep, ]

geneIDs <- na.omit(geneIDs) # drop the NAs, these are the genes we couldn't find an entrez id for 

rownames(qlf_modified) <- as.integer(geneIDs$ENTREZID)

# do some gene enrichment 
go <- goana(qlf_modified, species= "Hs")
keg <- kegga(qlf_modified, geneid = geneIDs$ENTREZID, species="Hs")

```

#### Diagnostic plots - these plots help us make sure that we fitted the right model to the data.  
This plots shows the relationship between the gene abundance in counts per million (cpm, x axis) and biological variation (y axis).  
We would expect to see high variation for low abundance, and a smooth decrease as the abundance increases. Red line (common) is average variation across  
all genes, for humans we would expect it to be around 0.4. Note that this means cells can differ as much as 40 % within one cluster. 

```{r echo = FALSE, message = FALSE, fig.height = 5, fig.width = 5}

plotBCV(dgeObject)

```

This plots shows how much we had to adjust (or in other words, squeeze) the data to control the gene variation. Black specks show the original count data for individual genes, and red specks are the adjusted data. We would look for how similar the original and adjusted counts are. If they don't look too different, we are on the right track!  
```{r echo = FALSE, message = FALSE, fig.height = 5, fig.width = 5}

plotQLDisp(fit)

```

#### Upregulated genes 
Now we take a closer look at the **upregulated** genes. To look for interesting genes, we do the following filtering:  
We don't show genes with log fold change (LogFC) less than 0.5. 
We also eliminate genes with p values more than 0.05.  

To help interpret, we use the follwing ranking system: 
Genes are ranked separately for log fold change (high to low) and p values (low to high). We then add these ranks together to get **summed_ranks.**  
Genes with smaller summed_ranks have high fold changes and low p values.

```{r echo = FALSE, message = FALSE, warning = FALSE}

# here we do some manipulation to show the upregulated genes in a meaningful way 
upregulated_genes_table <- make_upreg_table(qlf)%>%
  mutate_at(vars(logFC), funs(round(., 3)))

DT::datatable(upregulated_genes_table,
  extensions = 'Buttons',
  options = list(dom = 'Bfrtip',
                 buttons = list("copy", "excel", "csv", "pdf")))

# save the table to be loaded later 
write.csv(upregulated_genes_table, file = here('..', 'data', 'dge', 'edgeR_up', paste(params$ids)))

```

#### Downregulated genes 
Filtering and ranking systems is the same as upregulated genes, as explained above. Genes with the highest fold changes and lowest p values have lower summed_ranks.
  
```{r echo = FALSE, message = FALSE}

# here we do some manipulation to show the upregulated genes in a meaningful way 
downregulated_genes_table <- make_downreg_table(qlf) %>% 
  mutate_at(vars(logFC), funs(round(., 3)))

DT::datatable(downregulated_genes_table, 
  extensions = 'Buttons', 
  options = list(dom = 'Bfrtip', 
                 buttons = list("copy", "excel", "csv", "pdf")))

# save the table to be loaded later 
write.csv(downregulated_genes_table, file = here('..', 'data', 'dge', 'edgeR_down', paste(params$ids)))

```

#### Plot the differentially expressed genes 
Red symbolizes upregulated genes in cluster2 compared to cluster1.  
Blue symbolizes downregulated genes in cluster2 compared to cluster1.  
Black lines show 1 log fold change.  

```{r echo = FALSE, message = FALSE, fig.height = 6, fig.width = 6}
# plot the differentially expressed genes 

plotMD(qlf, main = 'DE genes', ylab = 'log2 fold change')
abline(h=c(-1,1), col="black")

```

Now we take a closer look at the genes visualized above. 
```{r echo = FALSE, message = FALSE}

summary <- summary(decideTests(qlf_threshold))

summary %>% 
    knitr::kable(caption = paste('DE genes')) %>% 
    kable_styling(full_width = F)

```

Now we take a look at the DE genes in a volcano plot. Note that we label the first 40 significantly up and downregulated genes in endometrial samples compared to ovarian samples.  
Fold change cut off is 1, p value cut off is 10e-5.  
```{r echo = FALSE, message = FALSE, fig.height = 6, fig.width = 11}
# we need to work on qlf a little bit so that we can use the enhancedvolcano function 

data <- qlf$table

data <- data %>% 
  dplyr::select(logFC, PValue) %>% 
  rename(log2FoldChange = logFC, pvalue = PValue)

cool_genes <- c(upregulated_genes_table[1][1: 15, ], downregulated_genes_table[1][1: 15, ])

library(EnhancedVolcano)

EnhancedVolcano(data,
  lab = rownames(data),
  x = 'log2FoldChange',
  y = 'pvalue',
  title = 'Differentially Expressed Genes',
  subtitle = 'endometrium vs ovary', 
  selectLab = cool_genes, 
  labCol = 'black',
  labFace = 'bold',
  drawConnectors = TRUE,
  widthConnectors = 0.4,
  colConnectors = 'black',
  pointSize = 0.7, 
  xlim = c(-10, 10), 
  FCcutoff = 1, 
  pCutoff = 10e-5, 
  legend=c('not significant','Log (base 2) fold-change','P value',
      'P value & Log (base 2) fold-change'), 
  legendPosition = 'right',
  legendLabSize = 8,
  legendIconSize = 5.0)


```


### Gene enrichment  
#### GO Pathway analysis  
Here we show the top most significantly enriched GO terms. This table shows the upregulated GO pathways in the cluster2 compared to cluster1.  

**Ont:**  
Note that GO shows three complementary biological concepts including Biological Process (BP), Molecular Function (MF) and Cellular Component (CC).  
You can find these in the 'Ont' column.  
**N:**  
total number of genes in the GO term  
**Up and Down:**  
the number of genes within the GO term that are significantly up and downregulated in this differential expression comparison, respectively.  
**P.Up and P.Down**  
the P.Up and P.Down columns contain the p-values for over-representation of the GO term in the up- and down-regulated genes, respectively.  
**P.Down**  

GO terms that are over represented in upregulated genes, comparing cluster2 to cluster1 
```{r echo = FALSE, message = FALSE}
# here we show the results of the go pathways 
gotable <- topGO(go, sort="up")

# do some cleaning up
DT::datatable(gotable, 
  extensions = 'Buttons', 
  options = list(dom = 'Bfrtip', 
                 buttons = list("copy", "excel", "csv", "pdf")))
  
```

GO terms that are over represented in donwregulated genes, comparing cluster2 to cluster1. 
```{r echo = FALSE, message = FALSE}
# here we show the results of the go pathways 
gotable_down <- topGO(go, sort="down")

# do some cleaning up
DT::datatable(gotable_down, 
  extensions = 'Buttons', 
  options = list(dom = 'Bfrtip', 
                 buttons = list("copy", "excel", "csv", "pdf")))
  
```

#### KEGG analysis  
KEGG pathways that are over represented in upregulated genes  

```{r echo = FALSE, message = FALSE}

# here we show the results of the KEGG analysis 
keggtable_up <- topKEGG(keg, sort="up")

# do some cleaning up
DT::datatable(keggtable_up, 
  extensions = 'Buttons', 
  options = list(dom = 'Bfrtip', 
                 buttons = list("copy", "excel", "csv", "pdf")))

```

KEGG pathways that are over represented in donwregulated genes  
```{r echo = FALSE, message = FALSE}

# here we show the results of the KEGG analysis 
keggtable_down <- topKEGG(keg, sort="down")

# do some cleaning up
DT::datatable(keggtable_down, 
  extensions = 'Buttons', 
  options = list(dom = 'Bfrtip', 
                 buttons = list("copy", "excel", "csv", "pdf")))


```

```{r include = FALSE}
# now we make heatmaps to show the pattern of expression across samples 

# logCPM <- cpm(dgeObject, prior.count=2, log=TRUE)
# rownames(logCPM) <- dgeObject$genes$Symbol
# colnames(logCPM) <- paste(dgeObject$samples$group, 1:2, sep="-")
# 
# o <- order(qlf_threshold$table$PValue)
# logCPM <- logCPM[o[1:30],]
# 
# heatmap <- coolmap(logCPM, margins=c(7,7), lhei=c(1,6), lwid=c(1,3))


```



```{r include = FALSE}

# barcodeplot(lrt$table$logFC,index=genesymbollist[[11531]],
# main="Barcodeplot for Gene 11531",
# labels=c("Negative logFC", "Positive logFC"),
# quantile=c(-0.5,0.5))


```


```{r include = FALSE}

# # this loads the gene sets into an object called Hs.c2
# geneset <- load(url("http://bioinf.wehi.edu.au/software/MSigDB/human_c2_v5p2.rdata"))
# 
# # convert to a list of index numbers:
# idx <- ids2indices(Hs.c2, id = rownames(dgeObject))
# 
# # comparison
# cam <- camera(dgeObject, idx, designMatrix, inter.gene.cor=0.01)
# > options(digits=2)
# > head(cam,14)

```























